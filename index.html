<!doctype html>
<html>
<head>
	<meta charset="UTF-8">
	<title>Web Converter</title>
	<link rel="stylesheet" href="css/dropzone.css">
	<link rel="stylesheet" href="css/style.css">
</head>
<body>
	<div id="container">
		<header>
			<h1 id="title">webconverter</h1>
			<span>convert image files & metadata</span>
		</header>
		<main>
			<form action="#" name="myDropzone" class="dropzone dz-clickable">
			  <div class="fallback">
			    <input name="file" type="file" accept="image/*" />
			  </div>
			</form>
			<div id="overlay">
			</div>
				<div class="previews">
				<!-- Previews kommer her -->
					<div class="pre-img">
						<!-- <img src="#" alt="#" /> -->
						<!-- <img src="http://s5.favim.com/orig/52/winter-nature-small-canon-eos-7d-Favim.com-474348.jpg" src="previmgr" alt="Demo img" />  -->
					</div>
					<div class="pre-cont">
						<table>
							<tr>
								<th colspan="2">Settings (<span class="filename"></span>)</th>
							</tr>
							<tr>
								<td>Convert from</td>
								<td>
									<select>
										<option>png</option>
										<option>jpg</option>
										<option>gif</option>
									</select>
								</td>
							</tr>
							<tr>
								<td>Convert to</td>
								<td>
									<select>
										<option>png</option>
										<option>jpg</option>
										<option>gif</option>
									</select>
								</td>
							</tr>
							<tr>
								<td>Dimensions</td>
								<td>
									<input type="text" class="wideinp" value="640" />px <strong>x</strong>
									<input type="text" class="tallinp" value="200" />px
								</td>
							</tr>
							<tr>
								<td class="alignright"><input type="checkbox" value="Delete metadata" /></td>
								<td>Delete metadata (<a href="#" class="metad" title="Clicking this won't leave the page">?</a>)</td>
							</tr>
							<tr>
								<td></td>
								<td><button type="submit">Convert</button>
							</tr>
							<tr class="aboutmeta">
							<td></td>
							<td>
							Metadata is information like what type of camera took the picture or when it was taken/made. 
							</td>
							</tr>
						</table>
					</div>
					<div class="clear"></div>
				</div>
			<form action="oldupload.php" method="post" id="testForm" enctype="multipart/form-data" class="temp-form">
			    <table>
				    <tr>
				   		<td>
				   			<input name="fileToUpload" id="rilfil" type="file" accept="image/*" />
				   		</td>
				    </tr>
				    <tr>
				    	<td>
				    		<button type="submit" id="andreasbutton">upload</button>
				    	</td>
				    	<td>
				    		<button class="popup" type="button">popup</button>
				    	</td>
				    </tr>
				    <tr>
				    	<td><img src="img/spinner.gif" id="spinner" /></td>
				    </tr>
			    </table>
			</form>
		</main>
	</div>
	<script src="https://code.jquery.com/jquery-1.12.0.min.js"></script><!-- require jQuery -->
	<script src="js/dropzone.js"></script> <!-- require dropzone -->
	<script src="js/main.js"></script>
	<script>
/* Dropzone */
Dropzone.options.myDropzone = {
  init: function() {
    this.on("success", function(file, responseText) {
      // Handle the responseText here. For example, add the text to the preview element:
      file.previewTemplate.appendChild(document.createTextNode(responseText));
    });
    this.on("addedfile", function(file) { 
      // Dropped file
      $("#overlay").fadeIn(300);
      $(".previews").delay(200).fadeIn(300);
      console.log("hmm???");
     });
  }
};
/* Popup/Overlay */
$(".popup").click(function(e){
  $("#overlay").fadeIn(300);
  $(".previews").delay(200).fadeIn(300);
  e.preventDefault();
  return false;
});
$("#overlay").click(function(){
  $(".previews").fadeOut(300);
  $(this).delay(200).fadeOut(300);
  $(".dz-image").remove();
  $(".previmgrt").remove();
});
$(".metad").click(function(){
	$(".aboutmeta").toggle();
	return false;
});
 $(document).keyup(function(e) {
	if (e.keyCode === 13) $('#andreasbutton').click();     // enter
	if (e.keyCode === 27) $('#overlay').click();   // esc
});
/* Make popup fade in on upload */
$(function() {
	$("input:file").change(function (){
		var fileName = $(this).val();
		$("#overlay").fadeIn(300);
		$(".previews").delay(200).fadeIn(300);
		$(".filename").html(fileName);
 	});
});

/*** Ajax test 1  ***//*
 $("#testForm").submit(function(e){
		var postData = $(this).serializeArray();
		var formURL = $(this).attr("action");
	    $.ajax({
	        url : formURL,
	        type: "POST",
	        crossDomain: false,
	        data : postData,
	        dataType: "json",
	        success:function(data, textStatus, jqXHR) 
	        {
	            //data: return data from server
	            console.log(json_encode(this.data));
	            console.log(this.data + "," + this.url);
	        },
	        error: function(jqXHR, textStatus, errorThrown) 
	        {
	            //if fails   
	            alert('it didnt work');   
	        }
	    	});
	    e.preventDefault(); //STOP default action
	    return false;
		});
	/*});*/

/*** Ajax test 2 ***/

$('form').on('submit', uploadFiles);

function uploadFiles(event)
{
  event.stopPropagation(); // Stop stuff happening
    event.preventDefault(); // Totally stop stuff happening

    // START A LOADING SPINNER HERE
    $("#spinner").fadeIn();

    // Create a formdata object and add the files
    var form = $("#testForm")[0];
    var data = new FormData(form);
    $("#rilfil").each(files, function(key, value){
        data.append(key, value);
    });

    $.ajax({
        url: 'oldupload.php?files',
        type: 'POST',
        data: data,
        cache: false,
        dataType: 'json',
        processData: false, // Don't process the files
        contentType: false, // Set content type to false as jQuery will tell the server its a query string request
        success: function(data, textStatus, jqXHR)
        {
            if(typeof data.error === 'undefined')
            {
                // Success so call function to process the form
                submitForm(event, data);
            }
            else
            {
                // Handle errors here
                console.log('ERRORS: ' + data.error);
            }
        },
        error: function(jqXHR, textStatus, errorThrown)
        {
            // Handle errors here
            console.log('ERRORS: ' + textStatus);
            // STOP LOADING SPINNER
        }
    });
}
/************************/
function submitForm(event, data){
  // Create a jQuery object from the form
    $form = $(event.target);

    // Serialize the form data
    var formData = $form.serialize();

    // You should sterilise the file names
    /*$.each(data.files, function(key, value)
    {
        formData = formData + '&filenames[]=' + value;
    });*/

    $.ajax({
        url: 'oldupload.php',
        type: 'POST',
        data: formData,
        cache: false,
        dataType: 'json',
        success: function(data, textStatus, jqXHR)
        {
            if(typeof data.error === 'undefined')
            {
                // Success so call function to process the form
                console.log('SUCCESS: ' + data.success);
            }
            else
            {
                // Handle errors here
                console.log('ERRORS: ' + data.error);
                alert("Error: " + data.error);
            }
        },
        error: function(jqXHR, textStatus, errorThrown)
        {
            // Handle errors here
            console.log('ERRORS: ' + textStatus);
        },
        complete: function()
        {
            // STOP LOADING SPINNER
            $("#spinner").fadeOut();
        }
    });
}
</script>
</body>
</html>
